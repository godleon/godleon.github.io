<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"godleon.github.io","root":"/blog/","scheme":"Muse","version":"8.0.0-rc.5","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false};
  </script>

  <meta name="description" content="此篇文章是在極客時間學習 Elasticsearch 課程時留下的一些學習筆記，主要內容包含 Elasticsearch 的基本概念 &amp; 搜尋入門">
<meta property="og:type" content="article">
<meta property="og:title" content="[Elasticsearch] 基本概念 &amp; 搜尋入門">
<meta property="og:url" content="https://godleon.github.io/blog/Elasticsearch/Elasticsearch-getting-started/index.html">
<meta property="og:site_name" content="小信豬的原始部落">
<meta property="og:description" content="此篇文章是在極客時間學習 Elasticsearch 課程時留下的一些學習筆記，主要內容包含 Elasticsearch 的基本概念 &amp; 搜尋入門">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_document-metadata.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_index-settings.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_cat-search-1.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_cat-search-2.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_cat-search-3.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_cat-search-4.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_cat-search-2.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_cat-search-3.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_cat-search-4.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_document-crud-get-example.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_invert-index-1.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_posting-list-example.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_analyzer-1.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_precision-and-recall.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_search-example-01.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_search-example-02.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_search-example-03.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_search-example-04.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_search-example-06.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_search-example-05.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_search-example-07.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_search-example-08.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_search-example-09.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_search-example-10.png">
<meta property="og:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_aggregation-01.png">
<meta property="article:published_time" content="2019-10-25T22:25:00.000Z">
<meta property="article:modified_time" content="2021-12-25T02:14:48.833Z">
<meta property="article:author" content="godleon">
<meta property="article:tag" content="Elasticsearch">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://godleon.github.io/blog/images/Elasticsearch/es_document-metadata.png">


<link rel="canonical" href="https://godleon.github.io/blog/Elasticsearch/Elasticsearch-getting-started/">


<script data-pjax class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>[Elasticsearch] 基本概念 & 搜尋入門 | 小信豬的原始部落</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-703592-7"></script>
    <script data-pjax>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-703592-7');
      }
    </script>






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">小信豬的原始部落</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%EF%BC%9AIndex%E3%80%81Document-%E5%92%8C-REST-API"><span class="nav-number">1.</span> <span class="nav-text">基本概念：Index、Document 和 REST API</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Document"><span class="nav-number">1.1.</span> <span class="nav-text">Document</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JSON-document"><span class="nav-number">1.1.1.</span> <span class="nav-text">JSON document</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Metadata"><span class="nav-number">1.1.2.</span> <span class="nav-text">Metadata</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Index"><span class="nav-number">1.2.</span> <span class="nav-text">Index</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Elasticsearch-%E8%88%87-RDBMS-%E7%9A%84%E6%AF%94%E8%BC%83-amp-%E5%8F%96%E6%8D%A8"><span class="nav-number">1.3.</span> <span class="nav-text">Elasticsearch 與 RDBMS 的比較 &amp; 取捨</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E6%90%9C%E5%B0%8B"><span class="nav-number">1.4.</span> <span class="nav-text">常用搜尋</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%A9%A2-index"><span class="nav-number">1.4.1.</span> <span class="nav-text">查詢 index</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%90%AD%E9%85%8D-cat-%E5%81%9A%E6%90%9C%E5%B0%8B"><span class="nav-number">1.4.2.</span> <span class="nav-text">搭配 _cat 做搜尋</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Document-%E7%9A%84%E5%9F%BA%E6%9C%AC-CRUD-%E8%88%87%E6%89%B9%E6%AC%A1%E6%93%8D%E4%BD%9C"><span class="nav-number">2.</span> <span class="nav-text">Document 的基本 CRUD 與批次操作</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Document-CRUD"><span class="nav-number">2.1.</span> <span class="nav-text">Document CRUD</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%B9%E6%AC%A1%E6%93%8D%E4%BD%9C"><span class="nav-number">2.2.</span> <span class="nav-text">批次操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#bulk"><span class="nav-number">2.2.1.</span> <span class="nav-text">&#x2F;_bulk</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mget"><span class="nav-number">2.2.2.</span> <span class="nav-text">&#x2F;_mget</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#msearch"><span class="nav-number">2.2.3.</span> <span class="nav-text">[&#x2F;_msearch]</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A0%85"><span class="nav-number">2.3.</span> <span class="nav-text">其他注意事項</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#API-%E8%A1%8C%E7%82%BA%E5%8D%80%E5%88%86"><span class="nav-number">2.4.</span> <span class="nav-text">API 行為區分</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Inverted-Index-%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95-%E4%BB%8B%E7%B4%B9"><span class="nav-number">3.</span> <span class="nav-text">Inverted Index(倒排索引)介紹</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Inverted-Index-%E7%B5%84%E6%88%90"><span class="nav-number">3.1.</span> <span class="nav-text">Inverted Index 組成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#References"><span class="nav-number">3.2.</span> <span class="nav-text">References</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%80%9A%E9%81%8E-Analyzer-%E9%80%B2%E8%A1%8C%E5%88%86%E8%A9%9E"><span class="nav-number">4.</span> <span class="nav-text">通過 Analyzer 進行分詞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Analyzer-%E7%9A%84%E7%B5%84%E6%88%90"><span class="nav-number">4.1.</span> <span class="nav-text">Analyzer 的組成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Elasticsearch-%E5%85%A7%E5%BB%BA%E7%9A%84-Analyzer"><span class="nav-number">4.2.</span> <span class="nav-text">Elasticsearch 內建的 Analyzer</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Search-API-%E6%A6%82%E8%A6%BD"><span class="nav-number">5.</span> <span class="nav-text">Search API 概覽</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%90%9C%E5%B0%8B%E8%88%87%E7%9B%B8%E9%97%9C%E6%80%A7"><span class="nav-number">5.1.</span> <span class="nav-text">搜尋與相關性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A1%A1%E9%87%8F%E7%9B%B8%E9%97%9C%E6%80%A7"><span class="nav-number">5.2.</span> <span class="nav-text">衡量相關性</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#URI-Search%E8%A9%B3%E8%A7%A3"><span class="nav-number">6.</span> <span class="nav-text">URI Search詳解</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%90%9C%E5%B0%8B%E7%AF%84%E4%BE%8B"><span class="nav-number">6.1.</span> <span class="nav-text">搜尋範例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Request-Body-%E8%88%87-Query-DSL-%E7%B0%A1%E4%BB%8B"><span class="nav-number">7.</span> <span class="nav-text">Request Body 與 Query DSL 簡介</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E8%88%AC%E6%9F%A5%E8%A9%A2%E7%AF%84%E4%BE%8B"><span class="nav-number">7.1.</span> <span class="nav-text">一般查詢範例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Scripted-Field-%E8%85%B3%E6%9C%AC%E6%AC%84%E4%BD%8D-Query"><span class="nav-number">7.2.</span> <span class="nav-text">Scripted Field(腳本欄位) Query</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%9F%A5%E8%A9%A2%E8%A1%A8%E9%81%94%E5%BC%8F-Match"><span class="nav-number">7.3.</span> <span class="nav-text">使用查詢表達式 - Match</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%9F%A5%E8%A9%A2%E8%A1%A8%E9%81%94%E5%BC%8F-Match-Phrase"><span class="nav-number">7.4.</span> <span class="nav-text">使用查詢表達式 - Match Phrase</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Query-String-amp-Simple-Query-String-%E6%9F%A5%E8%A9%A2"><span class="nav-number">8.</span> <span class="nav-text">Query String &amp; Simple Query String 查詢</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Query-String-Query"><span class="nav-number">8.1.</span> <span class="nav-text">Query String Query</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Simple-Query-String-Query"><span class="nav-number">8.2.</span> <span class="nav-text">Simple Query String Query</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Dynamic-Mapping-%E5%92%8C%E5%B8%B8%E8%A6%8B%E6%AC%84%E4%BD%8D%E9%A1%9E%E5%9E%8B"><span class="nav-number">9.</span> <span class="nav-text">Dynamic Mapping 和常見欄位類型</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#What-is-Mapping"><span class="nav-number">9.1.</span> <span class="nav-text">What is Mapping ?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Term-Data-Type"><span class="nav-number">9.2.</span> <span class="nav-text">Term Data Type</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B0%A1%E5%96%AE%E9%A1%9E%E5%9E%8B"><span class="nav-number">9.2.1.</span> <span class="nav-text">簡單類型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A4%87%E9%9B%9C%E9%A1%9E%E5%9E%8B"><span class="nav-number">9.2.2.</span> <span class="nav-text">複雜類型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%B9%E6%AE%8A%E9%A1%9E%E5%9E%8B"><span class="nav-number">9.2.3.</span> <span class="nav-text">特殊類型</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#What-is-Dynamic-Mapping"><span class="nav-number">9.3.</span> <span class="nav-text">What is Dynamic Mapping ?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AF%84%E4%BE%8B"><span class="nav-number">9.4.</span> <span class="nav-text">範例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9-Mapping-%E4%B8%AD%E7%9A%84%E6%AC%84%E4%BD%8D%E9%A1%9E%E5%9E%8B"><span class="nav-number">9.5.</span> <span class="nav-text">修改 Mapping 中的欄位類型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9-Mapping-%E7%AF%84%E4%BE%8B"><span class="nav-number">9.6.</span> <span class="nav-text">修改 Mapping 範例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%A1%AF%E5%BC%8F-Mapping-%E8%A8%AD%E7%BD%AE%E8%88%87%E5%B8%B8%E8%A6%8B%E5%8F%83%E6%95%B8%E4%BB%8B%E7%B4%B9"><span class="nav-number">10.</span> <span class="nav-text">顯式 Mapping 設置與常見參數介紹</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E7%BE%A9-mapping"><span class="nav-number">10.1.</span> <span class="nav-text">自定義 mapping</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Index-Options"><span class="nav-number">10.2.</span> <span class="nav-text">Index Options</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%81%B8%E6%93%87%E6%80%A7%E7%9A%84%E8%AE%93%E7%89%B9%E5%AE%9A-Field-%E4%B8%8D%E8%A2%AB%E7%B4%A2%E5%BC%95"><span class="nav-number">10.3.</span> <span class="nav-text">選擇性的讓特定 Field 不被索引</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NULL-value-%E7%9A%84%E8%99%95%E7%90%86"><span class="nav-number">10.4.</span> <span class="nav-text">NULL value 的處理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#copy-to-%E8%A8%AD%E5%AE%9A"><span class="nav-number">10.5.</span> <span class="nav-text">copy_to 設定</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Aray-Type"><span class="nav-number">10.6.</span> <span class="nav-text">Aray Type</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Multiple-Field-%E7%89%B9%E6%80%A7%E5%8F%8A-Mapping-%E4%B8%AD%E9%85%8D%E7%BD%AE%E8%87%AA%E5%AE%9A%E7%BE%A9-Analyzer"><span class="nav-number">11.</span> <span class="nav-text">Multiple Field 特性及 Mapping 中配置自定義 Analyzer</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Exact-Values-v-s-Full-Text"><span class="nav-number">11.1.</span> <span class="nav-text">Exact Values v.s. Full Text</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E8%A8%82%E5%88%86%E8%A9%9E%E5%99%A8-Analyzer"><span class="nav-number">11.2.</span> <span class="nav-text">自訂分詞器(Analyzer)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Character-Filter"><span class="nav-number">11.2.1.</span> <span class="nav-text">Character Filter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tokenizer"><span class="nav-number">11.2.2.</span> <span class="nav-text">Tokenizer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Token-Filter"><span class="nav-number">11.2.3.</span> <span class="nav-text">Token Filter</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AF%84%E4%BE%8B-1"><span class="nav-number">11.3.</span> <span class="nav-text">範例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Index-Template-%E5%92%8C-Dynamic-Template"><span class="nav-number">12.</span> <span class="nav-text">Index Template 和 Dynamic Template</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Index-Template"><span class="nav-number">12.1.</span> <span class="nav-text">Index Template</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dynamic-Template"><span class="nav-number">12.2.</span> <span class="nav-text">Dynamic Template</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Elasticsearch-%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90%E7%B0%A1%E4%BB%8B"><span class="nav-number">13.</span> <span class="nav-text">Elasticsearch 聚合分析簡介</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Aggregation"><span class="nav-number">13.1.</span> <span class="nav-text">Aggregation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Aggregation-Family-%E8%81%9A%E5%90%88%E7%B8%BD%E9%A1%9E"><span class="nav-number">13.2.</span> <span class="nav-text">Aggregation Family (聚合總類)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AF%84%E4%BE%8B%EF%BC%9ABucketing-%E5%88%86%E6%A1%B6"><span class="nav-number">13.3.</span> <span class="nav-text">範例：Bucketing (分桶)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AF%84%E4%BE%8B%EF%BC%9ABucketing-Metric"><span class="nav-number">13.4.</span> <span class="nav-text">範例：Bucketing + Metric</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AF%84%E4%BE%8B%EF%BC%9ABucketing-Metric-Matrix"><span class="nav-number">13.5.</span> <span class="nav-text">範例：Bucketing + Metric + Matrix</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AF%84%E4%BE%8B%EF%BC%9AHistogram"><span class="nav-number">13.6.</span> <span class="nav-text">範例：Histogram</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#References-1"><span class="nav-number">14.</span> <span class="nav-text">References</span></a></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">godleon</p>
  <div class="site-description" itemprop="description">把時間花在哪裡，成就就在哪裡</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives">
          <span class="site-state-item-count">165</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
        <span class="site-state-item-count">121</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </section>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://godleon.github.io/blog/Elasticsearch/Elasticsearch-getting-started/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="godleon">
      <meta itemprop="description" content="把時間花在哪裡，成就就在哪裡">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小信豬的原始部落">
    </span>

    
    
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          [Elasticsearch] 基本概念 & 搜尋入門
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-10-26 06:25:00" itemprop="dateCreated datePublished" datetime="2019-10-26T06:25:00+08:00">2019-10-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-12-25 10:14:48" itemprop="dateModified" datetime="2021-12-25T10:14:48+08:00">2021-12-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Elasticsearch/" itemprop="url" rel="index"><span itemprop="name">Elasticsearch</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/blog/Elasticsearch/Elasticsearch-getting-started/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Elasticsearch/Elasticsearch-getting-started/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
            <div class="post-description">此篇文章是在極客時間學習 Elasticsearch 課程時留下的一些學習筆記，主要內容包含 Elasticsearch 的基本概念 & 搜尋入門</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="基本概念：Index、Document-和-REST-API"><a href="#基本概念：Index、Document-和-REST-API" class="headerlink" title="基本概念：Index、Document 和 REST API"></a>基本概念：Index、Document 和 REST API</h1><ul>
<li><p>Index &amp; Document 是比較偏向開發人員視角，是種邏輯概念</p>
</li>
<li><p>Node &amp; Shard 是比較偏向維運人員的視角，是種物理概念</p>
</li>
</ul>
<h2 id="Document"><a href="#Document" class="headerlink" title="Document"></a>Document</h2><ul>
<li><p>Document 是可以被搜尋數據的最小單位(可能是 log 文件中的一筆紀錄 / 一部電影或唱片的相關訊息 / RDBMS 中的一筆 record)</p>
</li>
<li><p>Document 會被序列化成 JSON(由一堆 Key/Value 的資料組成，並有其資料格式) 格式，保存在 Elasticsearch 中</p>
</li>
<li><p>每個 Document 都有一個 UID(Unique ID)，可自己指定或交由 Elasticsearch 自動產生</p>
</li>
</ul>
<h3 id="JSON-document"><a href="#JSON-document" class="headerlink" title="JSON document"></a>JSON document</h3><ul>
<li><p>包含多個 Key/Value 組合，就像是資料庫中的一筆資料</p>
</li>
<li><p>但跟資料庫不一樣的是，JSON 格式靈活不受限，不須預先定義格式</p>
</li>
<li><p>每個 Key/Value 的類型(string, number, boolean … etc) 可以自己指定或是由 Elasticsearch 幫忙推算</p>
</li>
</ul>
<h3 id="Metadata"><a href="#Metadata" class="headerlink" title="Metadata"></a>Metadata</h3><p><img src="/blog/images/Elasticsearch/es_document-metadata.png" alt="Elasticsearch - document metadata example"></p>
<p>document metadata 就是描述 document 本身屬性用的資料，通常會包含以下內容：</p>
<ul>
<li><p><code>_index</code>：document 所屬的 index 名稱</p>
</li>
<li><p><code>_type</code>：document 類型 (例如：<strong>_doc</strong>)</p>
</li>
<li><p><code>_id</code>：document ID</p>
</li>
<li><p><code>_source</code>：document 的原始 JSON 資料樣貌</p>
</li>
<li><p><code>_version</code>：版本訊息 (有這欄位就表示 ES 具有版本控管的能力)</p>
</li>
<li><p><code>_score</code>：查詢時的算分結果 (每次的搜尋都會根據 document 對於搜尋內容的相關度進行算分)</p>
</li>
</ul>
<h2 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h2><ul>
<li><p><code>index</code> 在 ES 中是個邏輯空間的概念，用來儲存 document 的容器，而這些 document 內容都是相似的 (跟其他領域的 index 用法不太一樣)</p>
</li>
<li><p><code>shard</code> 在 ES 中則是個物理空間的的概念，<strong>index 中的資料會分散放在不同的 shard 中</strong></p>
</li>
<li><p>index 由以下幾個部份組成：</p>
<ul>
<li><code>data</code>：由 document + metadata 所組成</li>
<li><code>mapping</code>：用來定義每個欄位名稱 &amp; 類型</li>
<li><code>setting</code>：定義資料是如何存放(例如：replication 數量, 使用的 shard 數量)</li>
</ul>
</li>
<li><p>下圖是 <code>setting</code> 的設定範例：<br><img src="/blog/images/Elasticsearch/es_index-settings.png" alt="Elasticsearch - Index Settings"></p>
</li>
<li><p>在 ES 7.0 的版本後，index 在 <code>type</code> 部份只能設定為 <code>_doc</code> (在以前的版本是可以設定不同的 type)</p>
</li>
</ul>
<h2 id="Elasticsearch-與-RDBMS-的比較-amp-取捨"><a href="#Elasticsearch-與-RDBMS-的比較-amp-取捨" class="headerlink" title="Elasticsearch 與 RDBMS 的比較 &amp; 取捨"></a>Elasticsearch 與 RDBMS 的比較 &amp; 取捨</h2><p>以下表格是 Elasticsearch &amp; RDBMS 的對比：(不是完全符合，但概念上是很接近的)</p>
<table>
<thead>
<tr>
<th><strong>RDBMS</strong></th>
<th><strong>Elasticsearch</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Table</td>
<td>Index</td>
</tr>
<tr>
<td>Row</td>
<td>Document</td>
</tr>
<tr>
<td>Column</td>
<td>Field</td>
</tr>
<tr>
<td>Schema</td>
<td>Mapping</td>
</tr>
<tr>
<td>SQL</td>
<td>DSL</td>
</tr>
</tbody></table>
<ul>
<li><p>ES 是 schemaless 的，資料格式可以隨意定，非常適合用來做全文檢索 or 查詢與資料的相關性</p>
</li>
<li><p>RDBMS 的強項在於處理對於資料事務性(交易)要求特別高的任務</p>
</li>
</ul>
<h2 id="常用搜尋"><a href="#常用搜尋" class="headerlink" title="常用搜尋"></a>常用搜尋</h2><p>在 Kibana Dev Tools 頁面中，可以直接下查詢語法，以下舉幾個與 index 相關的搜尋：</p>
<h3 id="查詢-index"><a href="#查詢-index" class="headerlink" title="查詢 index"></a>查詢 index</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 取得指定 index 資訊，包含 mapping &amp; setting ... 等資訊</span></span><br><span class="line">GET kibana_sample_data_ecommerce</span><br><span class="line"></span><br><span class="line"><span class="comment"># 取得此 index 中的 document 數量</span></span><br><span class="line">GET kibana_sample_data_ecommerce/_count</span><br></pre></td></tr></table></figure>

<h3 id="搭配-cat-做搜尋"><a href="#搭配-cat-做搜尋" class="headerlink" title="搭配 _cat 做搜尋"></a>搭配 _cat 做搜尋</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 透過 _cat 查詢 index 相關資訊，搭配正規表示式 </span></span><br><span class="line">GET /_cat/indices/kibana*?v</span><br></pre></td></tr></table></figure>
<p><img src="/blog/images/Elasticsearch/es_cat-search-1.png" alt="Elasticsearch - _cat search 1"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 加上過濾條件</span></span><br><span class="line">GET /_cat/indices/kibana*?health=green</span><br></pre></td></tr></table></figure>
<p><img src="/blog/images/Elasticsearch/es_cat-search-2.png" alt="Elasticsearch - _cat search 2"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用排序</span></span><br><span class="line">GET /_cat/indices?v&amp;s=docs.count:desc</span><br></pre></td></tr></table></figure>
<p><img src="/blog/images/Elasticsearch/es_cat-search-3.png" alt="Elasticsearch - _cat search 3"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查詢每個 index 所消耗的 memory 為多少，搭配排序</span></span><br><span class="line">GET /_cat/indices?v&amp;h=i,tm&amp;s=tm:desc</span><br></pre></td></tr></table></figure>
<p><img src="/blog/images/Elasticsearch/es_cat-search-4.png" alt="Elasticsearch - _cat search 4"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 加上過濾條件</span></span><br><span class="line">GET /_cat/indices/kibana*?health=green</span><br></pre></td></tr></table></figure>
<p><img src="/blog/images/Elasticsearch/es_cat-search-2.png" alt="Elasticsearch - _cat search 2"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用排序</span></span><br><span class="line">GET /_cat/indices?v&amp;s=docs.count:desc</span><br></pre></td></tr></table></figure>
<p><img src="/blog/images/Elasticsearch/es_cat-search-3.png" alt="Elasticsearch - _cat search 3"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查詢每個 index 所消耗的 memory 為多少，搭配排序</span></span><br><span class="line">GET /_cat/indices?v&amp;h=i,tm&amp;s=tm:desc</span><br></pre></td></tr></table></figure>
<p><img src="/blog/images/Elasticsearch/es_cat-search-4.png" alt="Elasticsearch - _cat search 4"></p>
<h1 id="Document-的基本-CRUD-與批次操作"><a href="#Document-的基本-CRUD-與批次操作" class="headerlink" title="Document 的基本 CRUD 與批次操作"></a>Document 的基本 CRUD 與批次操作</h1><h2 id="Document-CRUD"><a href="#Document-CRUD" class="headerlink" title="Document CRUD"></a>Document CRUD</h2><ul>
<li><code>GET</code>：取得 document<ul>
<li>語法為 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-get.html"><code>GET _index/_type/[ID]</code></a>，例如 <strong>GET /users/_doc/1</strong></li>
<li>document 會有 version control 的功能，因此即使被刪除，version 欄位的值也會不斷增加</li>
<li><code>_source</code> 欄位包含了 document 的原始訊息</li>
</ul>
</li>
</ul>
<p><img src="/blog/images/Elasticsearch/es_document-crud-get-example.png" alt="Elasticsearch - document CRUD GET example"></p>
<ul>
<li><p><code>Create</code>(<strong>PUT</strong>)：</p>
<ul>
<li>建立新的 document，如果 ID 已經存在會發生錯誤</li>
<li>語法為 <code>PUT _index/_create/[ID]</code> or <code>PUT _index/_doc/[ID]?op_type=create</code>，例如：<strong>PUT /users/_create/1</strong> (也可以不帶 ID，就會自動生成)</li>
<li><strong>較不建議指定 ID 的作法，可能會撞到效能不彰的問題</strong></li>
</ul>
</li>
<li><p><code>Create</code>(<strong>POST</strong>)</p>
<ul>
<li>系統會自動產生 document ID (<strong>這是比較建議的方式</strong>)</li>
<li>語法為 <code>POST _index/_doc</code></li>
</ul>
</li>
<li><p><code>Index</code>(<strong>PUT</strong>)：</p>
<ul>
<li>如果 ID 不存在，則建立新的 document；若 ID 已經存在，則刪除現存的 document 再建立新的，<strong>version</strong> 的部份會增加</li>
<li>語法為 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-index_.html"><code>PUT _index/_doc/[ID]</code></a>，例如：<strong>PUT /users/_doc/1</strong></li>
</ul>
</li>
<li><p><code>Update</code>(<strong>PUT</strong>)：</p>
<ul>
<li>PUT 其實也可以作為更新 document 用，但更新的範圍是整個 document</li>
<li>實際上，Elasticsearch document 是無法修改的；而更新這個操作其實是新增一個新的 document，將原有的 <strong>_version</strong> 加 1 後，舊的 document 被標示為 <strong>deletion</strong></li>
</ul>
</li>
<li><p><code>Partially Update</code>(<strong>POST</strong>)：</p>
<ul>
<li>document 必須已經存在，更新時只會對 document 中相對應的欄位作增量更新 or 對應欄位的修改</li>
<li>json payload 需要包含在 <code>doc</code> 欄位中 (可參考<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-update.html">官網文件</a>) </li>
<li>語法為 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-update.html"><code>POST _index/_update/[ID]</code></a>，例如：<strong>POST /users/_update/1</strong></li>
<li>POST 也可以拿來作為新增 document 用</li>
</ul>
</li>
<li><p>呼叫 API 時傳輸的數據不宜過大(預設單一個 document 大小不能超過 100MB)，過大的 document 建議拆成 5~15MB 分次匯入</p>
</li>
</ul>
<h2 id="批次操作"><a href="#批次操作" class="headerlink" title="批次操作"></a>批次操作</h2><ul>
<li><p>批次操作基本上是用來提昇 API 呼叫時的效能</p>
</li>
<li><p>但每次的 API request 不要發送過多的資料，因為過多的資料可能會造成 ES cluster 過大的壓力導致效能下降(必須記得 ES cluster 每秒都需要服務相當多的 API request)</p>
</li>
</ul>
<p>Elasticsearch 中支援幾種批次操作 API，常用的有以下幾個：</p>
<h3 id="bulk"><a href="#bulk" class="headerlink" title="/_bulk"></a><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-bulk.html">/_bulk</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line"></span><br><span class="line">POST /&lt;target&gt;/_bulk</span><br></pre></td></tr></table></figure>

<ul>
<li><p>讓使用者可以在同一個 API request 中送出多個操作，支援 <strong>Index/Create/Update/Delete</strong>，提昇效率</p>
</li>
<li><p>request 中的每一筆資料都會有對應的 return code，其中的任何一個操作失敗不會影響其他操作</p>
</li>
</ul>
<p>範例如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST _bulk</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span> : &#123; <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;test&quot;</span>, <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span> &#125; &#125;</span><br><span class="line">&#123; <span class="string">&quot;field1&quot;</span> : <span class="string">&quot;value1&quot;</span> &#125;</span><br><span class="line">&#123; <span class="string">&quot;delete&quot;</span> : &#123; <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;test&quot;</span>, <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;2&quot;</span> &#125; &#125;</span><br><span class="line">&#123; <span class="string">&quot;create&quot;</span> : &#123; <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;test&quot;</span>, <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;3&quot;</span> &#125; &#125;</span><br><span class="line">&#123; <span class="string">&quot;field1&quot;</span> : <span class="string">&quot;value3&quot;</span> &#125;</span><br><span class="line">&#123; <span class="string">&quot;update&quot;</span> : &#123;<span class="string">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span>, <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;test&quot;</span>&#125; &#125;</span><br><span class="line">&#123; <span class="string">&quot;doc&quot;</span> : &#123;<span class="string">&quot;field2&quot;</span> : <span class="string">&quot;value2&quot;</span>&#125; &#125;</span><br></pre></td></tr></table></figure>

<h3 id="mget"><a href="#mget" class="headerlink" title="/_mget"></a><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-multi-get.html">/_mget</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET /_mget</span><br><span class="line"></span><br><span class="line">GET /&lt;index&gt;/_mget</span><br></pre></td></tr></table></figure>

<ul>
<li>一次讀取多個不同 index 中特定 ID 的 document</li>
</ul>
<p>使用範例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET /_mget</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;docs&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;my-index-000001&quot;</span>,</span><br><span class="line">      <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;1&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;my-index-000001&quot;</span>,</span><br><span class="line">      <span class="string">&quot;_id&quot;</span>: <span class="string">&quot;2&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="msearch"><a href="#msearch" class="headerlink" title="[/_msearch]"></a>[/_msearch]</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /&lt;target&gt;/_msearch</span><br></pre></td></tr></table></figure>

<ul>
<li><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-multi-search.html">官方文件說明</a></p>
</li>
<li><p>一次作多個大範圍的搜尋</p>
</li>
</ul>
<p>使用範例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET my-index-000001/_msearch</span><br><span class="line">&#123; &#125;</span><br><span class="line">&#123;<span class="string">&quot;query&quot;</span> : &#123;<span class="string">&quot;match&quot;</span> : &#123; <span class="string">&quot;message&quot;</span>: <span class="string">&quot;this is a test&quot;</span>&#125;&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;index&quot;</span>: <span class="string">&quot;my-index-000002&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;query&quot;</span> : &#123;<span class="string">&quot;match_all&quot;</span> : &#123;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>


<h2 id="其他注意事項"><a href="#其他注意事項" class="headerlink" title="其他注意事項"></a>其他注意事項</h2><ul>
<li><p>大版本的升級，document 必須重建 index</p>
</li>
<li><p>Elasticsearch 預設會提供 dynamic mapping 的功能，因此不用預先設定好 index 結構；但在生產環境中，建議先做好 mapping 的設定後再寫入資料</p>
</li>
<li><p>透過 X-Pack security plugin，可以提供 index-level or field-level 的 role based 資料存取控制</p>
</li>
</ul>
<h2 id="API-行為區分"><a href="#API-行為區分" class="headerlink" title="API 行為區分"></a>API 行為區分</h2><ul>
<li><p>index： 針對整個文檔，既可以新增又可以更新；</p>
</li>
<li><p>create：只是新增操作，已有報錯，可以用 PUT 指定 ID，或 POST 不指定 ID；</p>
</li>
<li><p>update：指的是部分更新，官方只是說用POST，request body 裡用 script 或 doc 裡包含文檔要更新的部分；</p>
</li>
<li><p>delete 和 read：就是 delete 和 get 請求了，比較簡單</p>
</li>
</ul>
<h1 id="Inverted-Index-倒排索引-介紹"><a href="#Inverted-Index-倒排索引-介紹" class="headerlink" title="Inverted Index(倒排索引)介紹"></a>Inverted Index(倒排索引)介紹</h1><ul>
<li><p>Forward Index(正排索引)：Document ID 到 Document 內容到單詞的關聯</p>
</li>
<li><p>Inverted Index(倒排索引)：單詞到 Document ID 的關係</p>
</li>
</ul>
<p><img src="/blog/images/Elasticsearch/es_invert-index-1.png" alt="Elasticsearch - Inverted Index"></p>
<h2 id="Inverted-Index-組成"><a href="#Inverted-Index-組成" class="headerlink" title="Inverted Index 組成"></a>Inverted Index 組成</h2><ul>
<li><p>Term Dictionary (單詞辭典)</p>
<ul>
<li>為了滿足快速的插入 &amp; 查詢，且因為 term 的數量龐大，因此通過 <strong>B+ tree</strong> or <strong>Open Hashing</strong> 的方式實現</li>
<li>記錄 Document 中所有的單詞，記錄單詞到 posting list(倒排列表) 的關聯關係</li>
</ul>
</li>
<li><p>Posting List (倒排列表)：由 posting(倒排索引項組合) 組成，包含以下內容：</p>
<ul>
<li>Document ID</li>
<li>詞頻 (Term Frequency)：term 在 document 中出現的次數，用在相關性評分</li>
<li>位置 (Position)：term 在 document 的位置，用在搜尋</li>
<li>偏移 (Offset)：記錄 trem 開始 &amp; 結束位置，用於高亮顯示</li>
</ul>
</li>
</ul>
<p><img src="/blog/images/Elasticsearch/es_posting-list-example.png" alt="Elasticsearch - Posting List"></p>
<ul>
<li><p>Elasticsearch 的 JSON document 中的 term 都會有自己的倒排索引</p>
</li>
<li><p>可以對某些欄位不作索引：</p>
<ul>
<li>優點：節省儲存空間</li>
<li>缺點：該欄位無法被搜尋</li>
</ul>
</li>
</ul>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/inverted-index.html">倒排索引 | Elasticsearch: 權威指南 | Elastic</a></li>
</ul>
<h1 id="通過-Analyzer-進行分詞"><a href="#通過-Analyzer-進行分詞" class="headerlink" title="通過 Analyzer 進行分詞"></a>通過 Analyzer 進行分詞</h1><ul>
<li><p>Analysis 是將 document 的內容轉換為一系列單詞(term/token) 的過程，也叫<strong>分詞</strong></p>
</li>
<li><p>Analysis 是由 Analyzer 來實現，Analyzer 由 <code>Character Filter</code> -&gt; <code>Tokenizer</code> -&gt; <code>Token Filter</code> 三個部份所組成，每個部份都可以自訂</p>
</li>
</ul>
<h2 id="Analyzer-的組成"><a href="#Analyzer-的組成" class="headerlink" title="Analyzer 的組成"></a>Analyzer 的組成</h2><p>Analyzer 是專門處理分詞的組件，由三個部份組成：</p>
<ul>
<li><p><code>Character Filter</code>：針對原始文件進行處理，例如：去除 HTML tag</p>
</li>
<li><p><code>Tokenizer</code>：根據規則切分 term</p>
</li>
<li><p><code>Token Filter</code>：將分割後的 term 進行加工，例如：轉小寫、刪除 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%81%9C%E7%94%A8%E8%AF%8D">stopwords</a>、增加同義詞、stemming(例如將 box, boxed, boxing … 等字轉換成 box)</p>
<blockquote>
<p>有時後會希望不要過濾 stopwords，而是直接把內容當成完整的 phrase 看待 (例如：<strong>to be or not to be</strong>)</p>
</blockquote>
</li>
</ul>
<p><img src="/blog/images/Elasticsearch/es_analyzer-1.png" alt="Elasticsearch - Analyzer"></p>
<ul>
<li>Elasticsearch 內建很多 Analyzer，每個 Analyzer 會由不同的 character filter, tokenizer, token filter 組合而成，使用者也可以自訂 Analyzer</li>
</ul>
<h2 id="Elasticsearch-內建的-Analyzer"><a href="#Elasticsearch-內建的-Analyzer" class="headerlink" title="Elasticsearch 內建的 Analyzer"></a>Elasticsearch 內建的 Analyzer</h2><p>以下是幾個 Elasticsearch 內建的 Analyzer，有興趣的人可以試試看每個 Analyzer 處理完後資料的效果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># character filter: standard (按詞切分)</span></span><br><span class="line"><span class="comment"># tokenizer: 轉小寫</span></span><br><span class="line"><span class="comment"># token filter: N/A (stopword 會保留)</span></span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;standard&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;2 running Quick brown-foxes leap over lazy dogs in the summer evening.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># character filter: simple (按詞切分，去除非字母字元)</span></span><br><span class="line"><span class="comment"># tokenizer: 轉小寫</span></span><br><span class="line"><span class="comment"># token filter: N/A (stopword 會保留)</span></span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;simple&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;2 running Quick brown-foxes leap over lazy dogs in the summer evening.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># character filter: simple (按詞切分，去除非字母字元)</span></span><br><span class="line"><span class="comment"># tokenizer: 轉小寫</span></span><br><span class="line"><span class="comment"># token filter: 去除 stopwords</span></span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;stop&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;2 running Quick brown-foxes leap over lazy dogs in the summer evening.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># character filter: whitespace (單純以空白切分)</span></span><br><span class="line"><span class="comment"># tokenizer: 轉小寫</span></span><br><span class="line"><span class="comment"># token filter: N/A (stopword 會保留)</span></span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;whitespace&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;2 running Quick brown-foxes leap over lazy dogs in the summer evening.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># character filter: N/A (不進行分詞)</span></span><br><span class="line"><span class="comment"># tokenizer: keyword (將所有的輸入直接轉成 token)</span></span><br><span class="line"><span class="comment"># token filter: N/A</span></span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;2 running Quick brown-foxes leap over lazy dogs in the summer evening.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># character filter: pattern (使用正規表示式分詞)</span></span><br><span class="line"><span class="comment"># tokenizer: 轉小寫</span></span><br><span class="line"><span class="comment"># token filter: N/A (stopword 會保留)</span></span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;pattern&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;2 running Quick brown-foxes leap over lazy dogs in the summer evening.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># character filter: english (使用英文辭典分詞)</span></span><br><span class="line"><span class="comment"># tokenizer: 轉小寫</span></span><br><span class="line"><span class="comment"># token filter: # token filter: 去除 stopwords</span></span><br><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;english&quot;</span>,</span><br><span class="line">  <span class="string">&quot;text&quot;</span>: <span class="string">&quot;2 running Quick brown-foxes leap over lazy dogs in the summer evening.&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="Search-API-概覽"><a href="#Search-API-概覽" class="headerlink" title="Search API 概覽"></a>Search API 概覽</h1><ul>
<li>search API 分成 <code>URI search</code>(使用 GET) &amp; <code>request body search</code>(同時支援 GET &amp; POST，使用 ES 提供的 DSL)</li>
</ul>
<p>查詢範圍：</p>
<table>
<thead>
<tr>
<th>語法</th>
<th>範圍</th>
</tr>
</thead>
<tbody><tr>
<td><code>/_search</code></td>
<td>cluster 上所有的 index</td>
</tr>
<tr>
<td><code>/index1/_search</code></td>
<td>index1</td>
</tr>
<tr>
<td><code>/index1,index2/_search</code></td>
<td>index1 + index2</td>
</tr>
<tr>
<td><code>/index*/_search</code></td>
<td>以 <strong>index</strong> 開頭的 index</td>
</tr>
</tbody></table>
<h2 id="搜尋與相關性"><a href="#搜尋與相關性" class="headerlink" title="搜尋與相關性"></a>搜尋與相關性</h2><ul>
<li><p>搜尋行為是客戶對於搜尋引擎的操作 &amp; 互動</p>
</li>
<li><p>客戶關心的是<strong>搜尋結果的相關性</strong>：</p>
<ul>
<li>是否可以找到相關的內容?</li>
<li>搜尋結果中包含了多少不相關的內容?</li>
<li>搜尋結果的算分是否合力</li>
<li>結合實際業務需求，平衡搜尋結果的排名</li>
</ul>
</li>
</ul>
<h2 id="衡量相關性"><a href="#衡量相關性" class="headerlink" title="衡量相關性"></a>衡量相關性</h2><p>Information Retrieval</p>
<ul>
<li><p>Precision (查準率)：盡可能返回較少的無關 document</p>
</li>
<li><p>Recall (查全率)：盡量返回較多的相關 document</p>
</li>
<li><p>Ranking：是否能夠依照相關度進行排序?</p>
</li>
</ul>
<p><img src="/blog/images/Elasticsearch/es_precision-and-recall.png" alt="Elasticsearch - Precision &amp; Recall"></p>
<h1 id="URI-Search詳解"><a href="#URI-Search詳解" class="headerlink" title="URI Search詳解"></a>URI Search詳解</h1><p>URI search 範例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /movies/_search?q=2012&amp;df=title&amp;sort=year:desc&amp;from=0&amp;size=10&amp;timeout=1s</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;profile&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>q</code>：指定查詢語句，使用 <strong>Query String Syntax</strong></p>
</li>
<li><p><code>df</code>：預設查詢的 field，若不指定則會對所有的 field 進行查詢</p>
</li>
<li><p><code>sort</code>：排序</p>
</li>
<li><p><code>from</code> &amp; <code>size</code> 用於分頁</p>
</li>
<li><p><code>profile</code>：可以檢查查詢是如何被執行的</p>
</li>
</ul>
<h2 id="搜尋範例"><a href="#搜尋範例" class="headerlink" title="搜尋範例"></a>搜尋範例</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基本查詢</span></span><br><span class="line"><span class="comment"># 明確指定 q, df, sort, from, size, timeout ... 等關鍵字</span></span><br><span class="line"><span class="comment"># 以 TermQuery 的方式查詢</span></span><br><span class="line">GET /movies/_search?q=2012&amp;df=title&amp;sort=year:desc&amp;from=0&amp;size=10&amp;timeout=1s</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;profile&quot;</span>: <span class="string">&quot;true&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>GET /movies/_search?q=2012&amp;df=title</code> == <code>GET /movies/_search?q=title:2012</code></p>
</blockquote>
<p><img src="/blog/images/Elasticsearch/es_search-example-01.png" alt="Elasticsearch - Search Example 1"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 泛查詢 =&gt; 對所有的 term 進行查詢</span></span><br><span class="line"><span class="comment"># 以 DisjunctionMaxQuery 的方式查詢</span></span><br><span class="line">GET /movies/_search?q=2012</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;profile&quot;</span>:<span class="string">&quot;true&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/blog/images/Elasticsearch/es_search-example-02.png" alt="Elasticsearch - Search Example 2"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 title 中尋找 &quot;Beautiful OR Mind&quot;</span></span><br><span class="line"><span class="comment"># 搜尋效果 =&gt; TermQuery(title:beautiful) + DisjunctionMaxQuery(在所有 term 中搜尋 mind)</span></span><br><span class="line"><span class="comment"># search type = BooleanQuery</span></span><br><span class="line">GET /movies/_search?q=title:Beautiful Mind</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;profile&quot;</span>:<span class="string">&quot;true&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/blog/images/Elasticsearch/es_search-example-03.png" alt="Elasticsearch - Search Example 3"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用引號 =&gt; &quot;Beautiful Mind&quot; = &quot;Beautiful AND Mind&quot;</span></span><br><span class="line"><span class="comment"># search type 為 PhraseQuery (同時出現 &amp; 按照順序)</span></span><br><span class="line">GET /movies/_search?q=title:<span class="string">&quot;Beautiful Mind&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;profile&quot;</span>:<span class="string">&quot;true&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用括號 =&gt; (Beautiful AND Mind) = &quot;Beautiful AND Mind&quot;</span></span><br><span class="line"><span class="comment"># search type 為 BooleanQuery</span></span><br><span class="line">GET /movies/_search?q=title:(Beautiful AND Mind)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;profile&quot;</span>:<span class="string">&quot;true&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/blog/images/Elasticsearch/es_search-example-04.png" alt="Elasticsearch - Search Example 4"></p>
<p><img src="/blog/images/Elasticsearch/es_search-example-06.png" alt="Elasticsearch - Search Example 6"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用括號 =&gt; (Beautiful Mind) = &quot;Beautiful OR Mind&quot;</span></span><br><span class="line"><span class="comment"># 搜尋效果 =&gt; TermQuery(title:beautiful) + TermQuery(title:mind)</span></span><br><span class="line"><span class="comment"># search type 為 BooleanQuery</span></span><br><span class="line">GET /movies/_search?q=title:(Beautiful Mind)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;profile&quot;</span>:<span class="string">&quot;true&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 title 中尋找 &quot;Beautiful +Mind&quot; (%2 = +)</span></span><br><span class="line"><span class="comment"># 搜尋效果 =&gt; TermQuery(title:beautiful) + TermQuery(+title:mind)</span></span><br><span class="line"><span class="comment"># mind 一定要出現，但 beautiful 不一定要出現</span></span><br><span class="line"><span class="comment"># search type = BooleanQuery</span></span><br><span class="line">GET /movies/_search?q=title:(Beautiful %2BMind)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;profile&quot;</span>:<span class="string">&quot;true&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/blog/images/Elasticsearch/es_search-example-05.png" alt="Elasticsearch - Search Example 5"></p>
<p><img src="/blog/images/Elasticsearch/es_search-example-07.png" alt="Elasticsearch - Search Example 7"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#正規表示式查詢</span></span><br><span class="line"><span class="comment"># 查詢出任何一個 term 為 b 開頭的 document</span></span><br><span class="line"><span class="comment"># search type = MultiTermQueryConstantScoreWrapper</span></span><br><span class="line">GET /movies/_search?q=title:b*</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;profile&quot;</span>:<span class="string">&quot;true&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/blog/images/Elasticsearch/es_search-example-08.png" alt="Elasticsearch - Search Example 8"></p>
<blockquote>
<p>查詢效率低，記憶體消耗大，不建議使用</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 模糊查詢 (即使 search term 有輸入錯誤，還是可以查詢)</span></span><br><span class="line"><span class="comment"># &quot;Beautiful Girls&quot;, &quot;Beautiful People&quot;, &quot;Beautiful Thing&quot; ... 都會被搜尋到</span></span><br><span class="line">GET /movies/_search?q=title:beautifl~1</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;profile&quot;</span>:<span class="string">&quot;true&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模糊查詢</span></span><br><span class="line"><span class="comment"># &quot;Lord of the Rings: The Two Towers, The&quot;, &quot;Lord of the Rings, The&quot; ... 都會被搜尋到</span></span><br><span class="line">GET /movies/_search?q=title:<span class="string">&quot;Lord Rings&quot;</span>~2</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;profile&quot;</span>:<span class="string">&quot;true&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/blog/images/Elasticsearch/es_search-example-09.png" alt="Elasticsearch - Search Example 9"></p>
<p><img src="/blog/images/Elasticsearch/es_search-example-10.png" alt="Elasticsearch - Search Example 10"></p>
<h1 id="Request-Body-與-Query-DSL-簡介"><a href="#Request-Body-與-Query-DSL-簡介" class="headerlink" title="Request Body 與 Query DSL 簡介"></a>Request Body 與 Query DSL 簡介</h1><ul>
<li>進階的查詢通常只能用 request body 的方式完成</li>
</ul>
<h2 id="一般查詢範例"><a href="#一般查詢範例" class="headerlink" title="一般查詢範例"></a>一般查詢範例</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ignore_unavailable=true，可以忽略嘗試訪問不存在的 index “404_idx” 導致的錯誤</span></span><br><span class="line"><span class="comment"># 查詢 movies index</span></span><br><span class="line"><span class="comment"># 開啟 profile</span></span><br><span class="line">POST /movies,404_idx/_search?ignore_unavailable=<span class="literal">true</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;profile&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">	<span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">		<span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 透過 from &amp; size 達到分頁效果</span></span><br><span class="line">POST /kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;from&quot;</span>:10,</span><br><span class="line">  <span class="string">&quot;size&quot;</span>:20,</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 對資料排序，使用 sort 參數</span></span><br><span class="line">POST kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>:[&#123;<span class="string">&quot;order_date&quot;</span>:<span class="string">&quot;desc&quot;</span>&#125;],</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># source filtering</span></span><br><span class="line"><span class="comment"># 當某些 document 很大時，僅針對特定的幾個 term 做查詢</span></span><br><span class="line">POST kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;_source&quot;</span>:[<span class="string">&quot;order_date&quot;</span>, <span class="string">&quot;category.keyword&quot;</span>],</span><br><span class="line">  <span class="string">&quot;from&quot;</span>: 10,</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 5, </span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Scripted-Field-腳本欄位-Query"><a href="#Scripted-Field-腳本欄位-Query" class="headerlink" title="Scripted Field(腳本欄位) Query"></a>Scripted Field(腳本欄位) Query</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 透過 ES 中 painless script 算出新的 field value</span></span><br><span class="line"><span class="comment"># 搜尋結果中都會加上 hello 作為結尾</span></span><br><span class="line">GET kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;script_fields&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;new_field&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;script&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;lang&quot;</span>: <span class="string">&quot;painless&quot;</span>,</span><br><span class="line">        <span class="string">&quot;source&quot;</span>: <span class="string">&quot;doc[&#x27;order_date&#x27;].value+&#x27;hello&#x27;&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;from&quot;</span>: 10, </span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 5,</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用查詢表達式-Match"><a href="#使用查詢表達式-Match" class="headerlink" title="使用查詢表達式 - Match"></a>使用查詢表達式 - Match</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 預設為 &quot;last OR christmas&quot;</span></span><br><span class="line">POST movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>: <span class="string">&quot;last christmas&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可透過 operator 改為 &quot;last AND christmas&quot;</span></span><br><span class="line">POST movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;last christmas&quot;</span>,</span><br><span class="line">        <span class="string">&quot;operator&quot;</span>: <span class="string">&quot;AND&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用查詢表達式-Match-Phrase"><a href="#使用查詢表達式-Match-Phrase" class="headerlink" title="使用查詢表達式 - Match Phrase"></a>使用查詢表達式 - Match Phrase</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 必須按照順序出現</span></span><br><span class="line">POST movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_phrase&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;one love&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加上 slop，中間可以有一個其他的 term 插入</span></span><br><span class="line">POST movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match_phrase&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: <span class="string">&quot;one love&quot;</span>,</span><br><span class="line">        <span class="string">&quot;slop&quot;</span>: 1</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="Query-String-amp-Simple-Query-String-查詢"><a href="#Query-String-amp-Simple-Query-String-查詢" class="headerlink" title="Query String &amp; Simple Query String 查詢"></a>Query String &amp; Simple Query String 查詢</h1><h2 id="Query-String-Query"><a href="#Query-String-Query" class="headerlink" title="Query String Query"></a>Query String Query</h2><ul>
<li>類似 URI Query</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可指定 default field(DF)</span></span><br><span class="line"><span class="comment"># 可指定 operrator</span></span><br><span class="line">POST /users/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;query_string&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;default_field&quot;</span>: <span class="string">&quot;tool&quot;</span>,</span><br><span class="line">      <span class="string">&quot;query&quot;</span>: <span class="string">&quot;Docker AND Kubernetes&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可指定多個 field</span></span><br><span class="line">POST /users/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;query_string&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;fields&quot;</span>:[<span class="string">&quot;tool&quot;</span>,<span class="string">&quot;about&quot;</span>],</span><br><span class="line">      <span class="string">&quot;query&quot;</span>: <span class="string">&quot;(Docker AND Kubernetes) OR (Java AND Elasticsearch)&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="Simple-Query-String-Query"><a href="#Simple-Query-String-Query" class="headerlink" title="Simple Query String Query"></a>Simple Query String Query</h2><ul>
<li><p>類似 Query String, 但會忽略錯誤的語法，並且僅支援部份查詢語法</p>
</li>
<li><p>不支援 <strong>AND</strong>/<strong>OR</strong>/<strong>NOT</strong>，會當作 term 來處理</p>
</li>
<li><p>term 之間預設的關係是 <code>OR</code>，可指定 <code>operator</code></p>
</li>
<li><p>支援使用 <code>+</code> 取代 <code>AND</code>，<code>|</code> 取代 <code>OR</code>，<code>-</code> 取代 <code>NOT</code></p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST /users/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;simple_query_string&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;query&quot;</span>: <span class="string">&quot;Docker Kubernetes&quot;</span>,</span><br><span class="line">      <span class="string">&quot;fields&quot;</span>: [<span class="string">&quot;tool&quot;</span>],</span><br><span class="line">      <span class="string">&quot;default_operator&quot;</span>: <span class="string">&quot;AND&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="Dynamic-Mapping-和常見欄位類型"><a href="#Dynamic-Mapping-和常見欄位類型" class="headerlink" title="Dynamic Mapping 和常見欄位類型"></a>Dynamic Mapping 和常見欄位類型</h1><h2 id="What-is-Mapping"><a href="#What-is-Mapping" class="headerlink" title="What is Mapping ?"></a>What is Mapping ?</h2><ul>
<li><p>Mapping 類似資料庫中的 schema 定義，用途如下：</p>
<ul>
<li><p>定義 index 中每個 term 的名稱</p>
</li>
<li><p>定義每個 term 的資料型態，例如：string, Interger, boolean</p>
</li>
<li><p>term &amp; inverted index 的相關配置 (要使用哪個 Analyzer，或是不被索引)</p>
</li>
</ul>
</li>
<li><p>Mapping 會將 JSON document 映射成 Lucene 所需要的扁平格式</p>
</li>
<li><p>一個 Mapping 屬於一個 index type</p>
<ul>
<li><p>每個 document 都屬於一個 type</p>
</li>
<li><p>一個 type 都會有一個 mapping 定義</p>
</li>
<li><p>7.0 開始，不需要在 mapping 定義中指定 type 資訊</p>
</li>
</ul>
</li>
</ul>
<h2 id="Term-Data-Type"><a href="#Term-Data-Type" class="headerlink" title="Term Data Type"></a>Term Data Type</h2><h3 id="簡單類型"><a href="#簡單類型" class="headerlink" title="簡單類型"></a>簡單類型</h3><ul>
<li><p>Text / Keyword</p>
</li>
<li><p>Date</p>
</li>
<li><p>Integer / Floating</p>
</li>
<li><p>Boolean</p>
</li>
<li><p>IPv4 &amp; IPv6</p>
</li>
</ul>
<h3 id="複雜類型"><a href="#複雜類型" class="headerlink" title="複雜類型"></a>複雜類型</h3><ul>
<li><p>Object</p>
</li>
<li><p>List</p>
</li>
</ul>
<h3 id="特殊類型"><a href="#特殊類型" class="headerlink" title="特殊類型"></a>特殊類型</h3><ul>
<li><p>geo_point &amp; geo_shape (地理訊息)</p>
</li>
<li><p>percolator</p>
</li>
</ul>
<h2 id="What-is-Dynamic-Mapping"><a href="#What-is-Dynamic-Mapping" class="headerlink" title="What is Dynamic Mapping ?"></a>What is Dynamic Mapping ?</h2><ul>
<li><p>在寫入 Document 時，如果 index 不存在，則會自動建立 index</p>
</li>
<li><p>Dynamic Mapping 可以根據 Document 內容，推算出 term data type 並自動建立 mapping，因此不需要手動制定</p>
</li>
<li><p>但推算的結果不一定會完全正確(例如：地理位置相關訊息可能會推斷錯誤)</p>
</li>
<li><p>term data type 推算錯誤可能會導致某些查詢無法正常使用，例如：range 查詢</p>
</li>
</ul>
<blockquote>
<p>若是濫用 Dynamic Mapping，導致不斷有新欄位出現卻不管制，cluster state 會一直變更調整，而這樣的調整會需要同步到 cluster 中的所有 node 上，若是因為大量的 field mapping 而導致更新 cluster state 的操作若是太頻繁，很有可能會導致記憶體不足的問題發生，甚至會導致 cluster 掛掉，這現象稱為 <code>Mapping Explosion</code> </p>
</blockquote>
<h2 id="範例"><a href="#範例" class="headerlink" title="範例"></a>範例</h2><p>簡單測試 Dynamic Mapping：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 寫入 document，mapping 會動態產生</span></span><br><span class="line">PUT mapping_test/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;firstName&quot;</span>:<span class="string">&quot;Chan&quot;</span>,</span><br><span class="line">  <span class="string">&quot;lastName&quot;</span>: <span class="string">&quot;Jackie&quot;</span>,</span><br><span class="line">  <span class="string">&quot;loginDate&quot;</span>:<span class="string">&quot;2018-07-24T10:29:48.103Z&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 透過 &quot;_mapping&quot; 可以查看 mapping 資訊</span></span><br><span class="line"><span class="comment"># firstName =&gt; text + keyword</span></span><br><span class="line"><span class="comment"># lastName =&gt; text + keyword</span></span><br><span class="line"><span class="comment"># loginDate =&gt; date</span></span><br><span class="line">GET mapping_test/_mapping</span><br><span class="line"></span><br><span class="line"><span class="comment"># 刪除 index</span></span><br><span class="line">DELETE mapping_test</span><br></pre></td></tr></table></figure>

<p>故意將某些資料類型加上雙引號測試：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># UID 應該為 long，加上雙引號</span></span><br><span class="line"><span class="comment"># isAdmin 應該為 boolean，加上雙引號</span></span><br><span class="line">PUT mapping_test/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;uid&quot;</span> : <span class="string">&quot;123&quot;</span>,</span><br><span class="line">    <span class="string">&quot;isVip&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;isAdmin&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">    <span class="string">&quot;age&quot;</span>:19,</span><br><span class="line">    <span class="string">&quot;heigh&quot;</span>:180</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 mapping 設定</span></span><br><span class="line"><span class="comment"># uid =&gt; text + keyword</span></span><br><span class="line"><span class="comment"># isVip =&gt; boolean</span></span><br><span class="line"><span class="comment"># isAdmin =&gt; text + keyword</span></span><br><span class="line"><span class="comment"># age =&gt; long</span></span><br><span class="line"><span class="comment"># height =&gt; long</span></span><br><span class="line">GET mapping_test/_mapping</span><br></pre></td></tr></table></figure>

<h2 id="修改-Mapping-中的欄位類型"><a href="#修改-Mapping-中的欄位類型" class="headerlink" title="修改 Mapping 中的欄位類型"></a>修改 Mapping 中的欄位類型</h2><p>在新增加欄位的情況下：</p>
<ul>
<li><p>若 dynamic = true，一旦有新增欄位的 document 寫入時，mapping 資訊也會同時被更新</p>
</li>
<li><p>若 dynamic = false，mapping 不會被更新，新增欄位的資料無法被索引，但是資料會出現在 <code>_source</code> 中</p>
</li>
<li><p>若 dynamic = strict，寫入 document 的操作會發生錯誤</p>
</li>
</ul>
<p>若是針對已經存在的欄位，使用其他欄位類型的資料進行寫入操作，是無法變更 mapping 設定的，因為一旦當 reverted index 已經生成後，就無法修改；而若是真的要改變欄位類型，則是需要透過 <code>Reindex API</code> 來重建索引。</p>
<blockquote>
<p>若是原有欄位的數據類型可以隨意修改，這樣會讓原本已經被索引的資料無法被搜尋</p>
</blockquote>
<table>
<thead>
<tr>
<th>Dynamic Mapping 設定</th>
<th>“true”</th>
<th>“false”</th>
<th>“strict”</th>
</tr>
</thead>
<tbody><tr>
<td>document 可索引</td>
<td>Yes</td>
<td>Yes</td>
<td>No (資料寫入會錯誤))</td>
</tr>
<tr>
<td>欄位可索引</td>
<td>Yes</td>
<td>No</td>
<td>No</td>
</tr>
<tr>
<td>Mapping 被更新</td>
<td>Yes</td>
<td>No (新增欄位被丟棄)</td>
<td>No</td>
</tr>
</tbody></table>
<h2 id="修改-Mapping-範例"><a href="#修改-Mapping-範例" class="headerlink" title="修改 Mapping 範例"></a>修改 Mapping 範例</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 預設 dynamic mapping 開啟，寫入新的 document 進 index 中</span></span><br><span class="line">PUT dynamic_mapping_test/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;newField&quot;</span>:<span class="string">&quot;someValue&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 資料可以被搜尋到，資料也同時出現在 _source 中</span></span><br><span class="line">POST dynamic_mapping_test/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;newField&quot;</span>:<span class="string">&quot;someValue&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 將 dynamic mapping 設定為 false</span></span><br><span class="line">PUT dynamic_mapping_test/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;dynamic&quot;</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新增 anotherField</span></span><br><span class="line">POST dynamic_mapping_test/_doc/10</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;anotherField&quot;</span>:<span class="string">&quot;someValue&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># anotherField 這一筆資料無法被搜索，因為 dynamic mapping 已經被設定為 false</span></span><br><span class="line">POST dynamic_mapping_test/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;anotherField&quot;</span>:<span class="string">&quot;someValue&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 檢視 mapping 設定，還是只有原本就存在的 newField 設定</span></span><br><span class="line">get dynamic_mapping_test/_mapping</span><br><span class="line"></span><br><span class="line"><span class="comment"># 將 dynamic mapping 設定修改為 strict</span></span><br><span class="line">PUT dynamic_mapping_test/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;dynamic&quot;</span>: <span class="string">&quot;strict&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此時寫入操作就會發生錯誤，HTTP Code 400</span></span><br><span class="line">PUT dynamic_mapping_test/_doc/12</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;lastField&quot;</span>:<span class="string">&quot;value&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 移除 index</span></span><br><span class="line">DELETE dynamic_mapping_test</span><br></pre></td></tr></table></figure>



<h1 id="顯式-Mapping-設置與常見參數介紹"><a href="#顯式-Mapping-設置與常見參數介紹" class="headerlink" title="顯式 Mapping 設置與常見參數介紹"></a>顯式 Mapping 設置與常見參數介紹</h1><h2 id="自定義-mapping"><a href="#自定義-mapping" class="headerlink" title="自定義 mapping"></a>自定義 mapping</h2><p>往 index 送 PUT request 並帶上 mappings 設定即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT movies</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    //define your mappings here</span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>撰寫 mapping 其實不是這麼容易，除了可以參考 API 來撰寫之外，也可以透過<strong>寫入一些 sample data 到一個臨時的 index，讓 Elasticsearch 自動產生 mapping 定義後，再根據實際需求進行修改</strong>。</p>
<h2 id="Index-Options"><a href="#Index-Options" class="headerlink" title="Index Options"></a>Index Options</h2><p>Inverted Index 根據要記錄的內容，有四種 index options 可以設定：</p>
<table>
<thead>
<tr>
<th>Index Option</th>
<th>Inverted Index 中的記錄內容</th>
</tr>
</thead>
<tbody><tr>
<td><code>docs</code></td>
<td>doc id</td>
</tr>
<tr>
<td><code>freqs</code></td>
<td>doc id + term frequency</td>
</tr>
<tr>
<td><code>positions</code></td>
<td>doc id + term frequency + term position</td>
</tr>
<tr>
<td><code>offsets</code></td>
<td>doc id + term frequency + term position + character offsets</td>
</tr>
</tbody></table>
<ul>
<li><p>type <code>text</code> 預設使用 <code>positions</code>，其他則為 <code>docs</code></p>
</li>
<li><p>記錄的資料越多，需要儲存空間越多</p>
</li>
</ul>
<h2 id="選擇性的讓特定-Field-不被索引"><a href="#選擇性的讓特定-Field-不被索引" class="headerlink" title="選擇性的讓特定 Field 不被索引"></a>選擇性的讓特定 Field 不被索引</h2><p>預設情況下每個 field 都會被索引，但若是確定特定的 field 資料不需要被查詢，也可以不被索引：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">PUT /users</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;properties&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;firstName&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;lastName&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">//將 index 設定為 false，ES 就不會索引該 field 的資料</span></span><br><span class="line">        <span class="attr">&quot;mobile&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;index&quot;</span>: <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 新增資料</span></span><br><span class="line">PUT /users/_doc/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;firstName&quot;</span>:<span class="string">&quot;Leon&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;lastName&quot;</span>: <span class="string">&quot;Tseng&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;mobile&quot;</span>: <span class="string">&quot;12345678&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 搜尋會發生錯誤</span></span><br><span class="line"><span class="comment">// Cannot search on field [mobile] since it is not indexed.</span></span><br><span class="line">POST /users/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;mobile&quot;</span>:<span class="string">&quot;12345678&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="NULL-value-的處理"><a href="#NULL-value-的處理" class="headerlink" title="NULL value 的處理"></a>NULL value 的處理</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">PUT /users</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;properties&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;firstName&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;lastName&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;mobile&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">          <span class="comment">//可以透過給一個 &quot;NULL&quot; 字串的方式</span></span><br><span class="line">          <span class="comment">//讓 ES 協助生成一個 keyword field 來搜尋</span></span><br><span class="line">          <span class="attr">&quot;null_value&quot;</span>: <span class="string">&quot;NULL&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//新增資料1</span></span><br><span class="line">PUT /users/_doc/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;firstName&quot;</span>:<span class="string">&quot;Leon&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;lastName&quot;</span>: <span class="string">&quot;Tseng&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;mobile&quot;</span>: <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//新增資料2</span></span><br><span class="line">PUT /users/_doc/<span class="number">2</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;firstName&quot;</span>:<span class="string">&quot;Leon2&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;lastName&quot;</span>: <span class="string">&quot;Tseng2&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//只會找到資料1</span></span><br><span class="line"><span class="comment">//而且實際存在於 ES 中的是 null 值而非字串 </span></span><br><span class="line">GET /users/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;mobile&quot;</span>:<span class="string">&quot;NULL&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="copy-to-設定"><a href="#copy-to-設定" class="headerlink" title="copy_to 設定"></a>copy_to 設定</h2><p>透過 <code>copy_to</code> 的設定可以新增一個 field，實現類似 <code>_all</code> 的效果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">PUT /users</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;firstName&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="comment">//firstName 資料會被複製到 fullName 中</span></span><br><span class="line">        <span class="attr">&quot;copy_to&quot;</span>: <span class="string">&quot;fullName&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;lastName&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="comment">//lastName 資料會被複製到 fullName 中</span></span><br><span class="line">        <span class="attr">&quot;copy_to&quot;</span>: <span class="string">&quot;fullName&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//新增資料</span></span><br><span class="line">PUT users/_doc/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;firstName&quot;</span>:<span class="string">&quot;Leon1&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;lastName&quot;</span>: <span class="string">&quot;Tseng1&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//對新欄位查詢資料</span></span><br><span class="line">GET /users/_search?q=fullName=(Leon1)</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>_all</code> 在 ES 7 後被 <code>copy_to</code> 取代</p>
</li>
<li><p>上述範例中，使用者可以針對 <code>fullName</code> 進行搜尋</p>
</li>
<li><p><code>fullName</code> 的資料不會出現在 <code>_source</code> 中</p>
</li>
</ul>
<h2 id="Aray-Type"><a href="#Aray-Type" class="headerlink" title="Aray Type"></a>Aray Type</h2><p>目前 Elasticsearch 不支援 array type，但每個 field 都可以包含多個相同類型的數值：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//新增一個帶有 string array 的資料</span></span><br><span class="line">PUT /users/_doc/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;twobirds&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;interests&quot;</span>:[<span class="string">&quot;reading&quot;</span>,<span class="string">&quot;music&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//可以正確被搜尋</span></span><br><span class="line">POST /users/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">		<span class="attr">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//而 name &amp; interests 的 data type 都同樣被設定為 text</span></span><br><span class="line">GET /users/_mapping</span><br></pre></td></tr></table></figure>

<blockquote>
<p>表示 <code>text</code> type 其實是可以記錄 array type 的資料 (其實其他 type 也是可以記錄 array type 資料，例如：<code>long</code>))</p>
</blockquote>
<h1 id="Multiple-Field-特性及-Mapping-中配置自定義-Analyzer"><a href="#Multiple-Field-特性及-Mapping-中配置自定義-Analyzer" class="headerlink" title="Multiple Field 特性及 Mapping 中配置自定義 Analyzer"></a>Multiple Field 特性及 Mapping 中配置自定義 Analyzer</h1><ul>
<li><p>multiple field 資料中，可透過 <code>keyword</code> field 作精確搜尋</p>
</li>
<li><p>若是要做全文搜尋，則是使用 <code>text</code> field 並搭配不同的 <strong>analyzer</strong> &amp; <strong>search analyzer</strong></p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">PUT products</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;company&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>, </span><br><span class="line">        <span class="attr">&quot;fields&quot;</span>: &#123;</span><br><span class="line">          <span class="comment">//利用 keyword field 來實現精確匹配</span></span><br><span class="line">          <span class="attr">&quot;keyword&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>, </span><br><span class="line">            <span class="attr">&quot;ignore_above&quot;</span>: <span class="number">256</span> </span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, </span><br><span class="line">      <span class="attr">&quot;comment&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>, </span><br><span class="line">        <span class="attr">&quot;fields&quot;</span>: &#123;</span><br><span class="line">          <span class="comment">//可以在 field 中增加 sub-field，並指定不同的 analyer &amp; search analyzer</span></span><br><span class="line">          <span class="comment">//針對需要進行全文檢索的欄位，設定不同的 analyzer &amp; search analyzer</span></span><br><span class="line">          <span class="attr">&quot;english_comment&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;english&quot;</span>,  <span class="comment">//索引用的 analyzer</span></span><br><span class="line">            <span class="attr">&quot;search_analyzer&quot;</span>: <span class="string">&quot;english&quot;</span>  <span class="comment">//搜尋用的 analyzer</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Exact-Values-v-s-Full-Text"><a href="#Exact-Values-v-s-Full-Text" class="headerlink" title="Exact Values v.s. Full Text"></a>Exact Values v.s. Full Text</h2><ul>
<li><p>Exact Value 包含數字/日期/或是特定的字串(例如：”Apple Store”)，在 Elasticsearch 中的 <code>keyword</code> field 存放的就是這一類的資料</p>
</li>
<li><p>Full Text 則是非結構化的資料，在 Elasticsearch 中的 <code>text</code> field 存放的就是這一類的資料</p>
</li>
<li><p>Exact Values 不需要做分詞處理，而 Full Text 則會需要分詞處理才能更容易被後續利用</p>
</li>
</ul>
<h2 id="自訂分詞器-Analyzer"><a href="#自訂分詞器-Analyzer" class="headerlink" title="自訂分詞器(Analyzer)"></a>自訂分詞器(Analyzer)</h2><p>Analyzer 是專門處理分詞的組件，由三個部份組成：</p>
<ul>
<li><p>Character Filter (針對原始文件進行處理，例如：去除 HTML tag)</p>
</li>
<li><p>Tokenizer (根據規則將資料切分 term or token)</p>
</li>
<li><p>Token Filter (將分割後的 term 進行加工，例如：轉小寫、刪除 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%81%9C%E7%94%A8%E8%AF%8D">stopwords</a>、增加同義詞)</p>
</li>
</ul>
<h3 id="Character-Filter"><a href="#Character-Filter" class="headerlink" title="Character Filter"></a>Character Filter</h3><ul>
<li><p><strong>可同時設定多個 Character Filter</strong></p>
</li>
<li><p>會影響 Tokenizer 的 position &amp; offset 的資訊</p>
</li>
<li><p>目前 Elasticsearch 內建提供的 Character Filter 有 HTML strip、Mapping、Patter replace …等等</p>
</li>
</ul>
<h3 id="Tokenizer"><a href="#Tokenizer" class="headerlink" title="Tokenizer"></a>Tokenizer</h3><ul>
<li><p><strong>只能設定一個 tokenizer</strong></p>
</li>
<li><p>將 Character Filter 處理過後的資料，按照一定的規則，切分為詞(term or token)</p>
</li>
<li><p>目前 Elasticsearch 內建提供的 tokenizer 有 <code>whitespace</code>/<code>standard</code>/<code>uax_url_email</code>/<code>pattern</code>/<code>keyword</code>(不做任何處理)/<code>path hierarchy</code></p>
</li>
<li><p>也可以用 Java 實作自己的 tokenizer</p>
</li>
</ul>
<h3 id="Token-Filter"><a href="#Token-Filter" class="headerlink" title="Token Filter"></a>Token Filter</h3><ul>
<li><p><strong>可同時設定多個 Token Filter</strong></p>
</li>
<li><p>將 Tokenizer 輸出的 term(or token) 進行增加、修改、刪除</p>
</li>
<li><p>目前 Elasticsearch 內建提供的 Token Filter 有 <code>lowercase</code>/<code>stop</code>/<code>synonym</code> …  等等</p>
</li>
</ul>
<h2 id="範例-1"><a href="#範例-1" class="headerlink" title="範例"></a>範例</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//將 HTML tag 去除</span></span><br><span class="line">  <span class="attr">&quot;char_filter&quot;</span>:[<span class="string">&quot;html_strip&quot;</span>],</span><br><span class="line"></span><br><span class="line">  <span class="comment">//keyword 不會進行分詞，會保留全部資料</span></span><br><span class="line">  <span class="attr">&quot;tokenizer&quot;</span>:<span class="string">&quot;keyword&quot;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;&lt;b&gt;hello world&lt;/b&gt;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//會將所有可能的目錄結構的分出來</span></span><br><span class="line">  <span class="comment">//例如：&quot;/user&quot;, &quot;/user/ymruan&quot;, &quot;/user/ymruan/a&quot; .... etc</span></span><br><span class="line">  <span class="attr">&quot;tokenizer&quot;</span>:<span class="string">&quot;path_hierarchy&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>:<span class="string">&quot;/user/ymruan/a/b/c/d/e&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//會根據 mapping 設定進行字串的取代</span></span><br><span class="line">  <span class="attr">&quot;char_filter&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;mapping&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;mappings&quot;</span> : [ <span class="string">&quot;- =&gt; _&quot;</span>]</span><br><span class="line">      &#125;</span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">  <span class="comment">//標準分詞</span></span><br><span class="line">  <span class="attr">&quot;tokenizer&quot;</span>: <span class="string">&quot;standard&quot;</span>,</span><br><span class="line">  </span><br><span class="line">  <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;123-456, I-test! test-990 650-555-1234&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//char filter 替換表情符號</span></span><br><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//透過 mapping 將表情符號替換成一般字串</span></span><br><span class="line">  <span class="attr">&quot;char_filter&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;mapping&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;mappings&quot;</span> : [ <span class="string">&quot;:) =&gt; happy&quot;</span>, <span class="string">&quot;:( =&gt; sad&quot;</span>]</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;tokenizer&quot;</span>: <span class="string">&quot;standard&quot;</span>,</span><br><span class="line">  </span><br><span class="line">    <span class="attr">&quot;text&quot;</span>: [<span class="string">&quot;I am felling :)&quot;</span>, <span class="string">&quot;Feeling :( today&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//使用空白進行分詞</span></span><br><span class="line">  <span class="attr">&quot;tokenizer&quot;</span>: <span class="string">&quot;whitespace&quot;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">//stop words 會被忽略</span></span><br><span class="line">  <span class="comment">//若改成 [&quot;lowercase&quot;, &quot;stop&quot;]，下面的 &quot;The&quot; 就會被過濾掉了</span></span><br><span class="line">  <span class="attr">&quot;filter&quot;</span>: [<span class="string">&quot;stop&quot;</span>],</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//&quot;The&quot; 會保留著，因為首字母並非小寫</span></span><br><span class="line">  <span class="attr">&quot;text&quot;</span>: [<span class="string">&quot;The rain in Spain falls mainly on the plain.&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET _analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//使用 regular express 進行資料處理</span></span><br><span class="line">  <span class="attr">&quot;char_filter&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;pattern_replace&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;pattern&quot;</span> : <span class="string">&quot;http://(.*)&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;replacement&quot;</span> : <span class="string">&quot;$1&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;tokenizer&quot;</span>: <span class="string">&quot;standard&quot;</span>,</span><br><span class="line">  </span><br><span class="line">    <span class="attr">&quot;text&quot;</span> : <span class="string">&quot;http://www.elastic.co&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可以完全自己定義一個 Analyzer：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;analysis&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;analyzer&quot;</span>: &#123;</span><br><span class="line">        <span class="comment">//裡面使用的 character filter, tokenizer, token filter 幾乎都是下面自行定義的</span></span><br><span class="line">        <span class="attr">&quot;my_custom_analyzer&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;custom&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;char_filter&quot;</span>: [ <span class="string">&quot;emoticons&quot;</span> ], </span><br><span class="line">          <span class="attr">&quot;tokenizer&quot;</span>: <span class="string">&quot;punctuation&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;filter&quot;</span>: [ <span class="string">&quot;lowercase&quot;</span>, <span class="string">&quot;english_stop&quot;</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, </span><br><span class="line">      <span class="comment">//自訂 character filter =&gt; emoticons</span></span><br><span class="line">      <span class="attr">&quot;char_filter&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;emoticons&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;mapping&quot;</span>, </span><br><span class="line">          <span class="attr">&quot;mappings&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;:) =&gt; _happy_&quot;</span>, </span><br><span class="line">            <span class="string">&quot;:( =&gt; _sad_&quot;</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, </span><br><span class="line">      <span class="comment">//自訂 tokenizer =&gt; punctuation</span></span><br><span class="line">      <span class="attr">&quot;tokenizer&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;punctuation&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;pattern&quot;</span>, </span><br><span class="line">          <span class="attr">&quot;pattern&quot;</span>: <span class="string">&quot;[ .,!?]&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, </span><br><span class="line">      <span class="comment">//自訂 token filter =&gt; english_stop</span></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;english_stop&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;stop&quot;</span>, </span><br><span class="line">          <span class="attr">&quot;stopwords&quot;</span>: <span class="string">&quot;_english_&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//驗證上面自訂的 analyzer</span></span><br><span class="line">POST my_index/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;my_custom_analyzer&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;I&#x27;m a :) person, and you&quot;</span></span><br></pre></td></tr></table></figure>



<h1 id="Index-Template-和-Dynamic-Template"><a href="#Index-Template-和-Dynamic-Template" class="headerlink" title="Index Template 和 Dynamic Template"></a>Index Template 和 Dynamic Template</h1><ul>
<li>若 cluster 是用來做 log 管理，每天都產生一個專屬的 index 存放 log，數據管理上較為合理，效能表現也會較好</li>
</ul>
<h2 id="Index-Template"><a href="#Index-Template" class="headerlink" title="Index Template"></a>Index Template</h2><p>Index Template 使用來協助使用者設定 mappings &amp; settings 的相關規則，並可透過套用 template 建立新的 index 來取得在 template 中已經存在的設定</p>
<ul>
<li><p>index template 只有在建立 index 有用，後續修改 template 不會影響已經存在的 index</p>
</li>
<li><p>可以設定多個 index template，這些設定會被合併在一起</p>
</li>
<li><p>也可以透過指定 <code>order</code>，來調整 index template 合併的過程</p>
</li>
</ul>
<p>那 index template 是如何在 index 被新增時運作的呢?</p>
<ol>
<li><p>先選用 Elasticsearch 中預設的 settings &amp; mappings</p>
</li>
<li><p>先套用 order 值低的 index template 中的設定</p>
</li>
<li><p>再套用 order 值高的 index template 中的設定，並覆蓋之前的設定</p>
</li>
<li><p>如果建立 index 時使用者有指定 settings &amp; mappings，就會覆蓋 index template 的設定</p>
</li>
</ol>
<p>以下透過簡單範例，說明 index template 的建立跟使用時實際的流程：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//建立 default index template</span></span><br><span class="line"><span class="comment">//並設定 order = 0</span></span><br><span class="line">PUT _template/template_default</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;index_patterns&quot;</span>: [<span class="string">&quot;*&quot;</span>],</span><br><span class="line">  <span class="attr">&quot;order&quot;</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;number_of_shards&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;number_of_replicas&quot;</span>:<span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//設定 index 為 test 開頭的 index template</span></span><br><span class="line"><span class="comment">//並設定 order = 1</span></span><br><span class="line"><span class="comment">//因此 test 開頭的 index 會優先套用此設定</span></span><br><span class="line">PUT _template/template_test</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;index_patterns&quot;</span> : [<span class="string">&quot;test*&quot;</span>],</span><br><span class="line">    <span class="attr">&quot;order&quot;</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;settings&quot;</span> : &#123;</span><br><span class="line">    	<span class="attr">&quot;number_of_shards&quot;</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="comment">//調整 replica 的數量</span></span><br><span class="line">      <span class="attr">&quot;number_of_replicas&quot;</span> : <span class="number">2</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span> : &#123;</span><br><span class="line">    	<span class="comment">//取消日期的偵測</span></span><br><span class="line">      <span class="attr">&quot;date_detection&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="comment">//開啟數字的偵測</span></span><br><span class="line">    	<span class="attr">&quot;numeric_detection&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查詢單一 index template 內容</span></span><br><span class="line">GET /_template/template_default</span><br><span class="line"><span class="comment">//查詢所有 &quot;temp&quot; 開頭的 index template 資訊</span></span><br><span class="line">GET /_template/temp*</span><br><span class="line"></span><br><span class="line"><span class="comment">//新增一個名稱為 testtemplate 的 index，並新增一筆資料</span></span><br><span class="line"><span class="comment">//由於名稱為 test 開頭，因此會套用 template_test 的設定</span></span><br><span class="line">PUT testtemplate/_doc/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;someNumber&quot;</span>:<span class="string">&quot;1&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;someDate&quot;</span>:<span class="string">&quot;2019/01/01&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//日期不會被偵測，而被當作一般的 text，而數字則是會偵測為 long</span></span><br><span class="line">GET testtemplate/_mapping</span><br><span class="line"><span class="comment">//shard = 1, replica = 2</span></span><br><span class="line">GET testtemplate/_setting</span><br><span class="line"></span><br><span class="line"><span class="comment">//新增一個 index，並自行指定 settings</span></span><br><span class="line"><span class="comment">//自行指定 settings 就會覆蓋 index template 中的所有設定</span></span><br><span class="line">PUT testmy</span><br><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;settings&quot;</span>:&#123;</span><br><span class="line">		<span class="attr">&quot;number_of_replicas&quot;</span>:<span class="number">5</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//新增資料到 testmy index 中</span></span><br><span class="line">put testmy/_doc/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;key&quot;</span>:<span class="string">&quot;value&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//index template 中的 settings 被覆蓋成上面指定的 &quot;number_of_replicas&quot;:5</span></span><br><span class="line">get testmy/_settings</span><br><span class="line"></span><br><span class="line"><span class="comment">//移除 index</span></span><br><span class="line">DELETE testmy</span><br><span class="line">DELETE /_template/template_default</span><br><span class="line">DELETE /_template/template_test</span><br></pre></td></tr></table></figure>

<h2 id="Dynamic-Template"><a href="#Dynamic-Template" class="headerlink" title="Dynamic Template"></a>Dynamic Template</h2><p>dynamic template 相較於前面提到的 index template，擁有比較彈性的方式來制定 template，例如：</p>
<ul>
<li><p>將所有 field 都設定成 keyword，或是關閉 keyword field</p>
</li>
<li><p>將 <code>is</code> 開頭的 field 都設定為 boolean</p>
</li>
<li><p>將 <code>long</code> 開頭的 field 都設定為 long 類型</p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用內建的自動辨識</span></span><br><span class="line">PUT my_index/_doc/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;firstName&quot;</span>:<span class="string">&quot;Ruan&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;isVIP&quot;</span>:<span class="string">&quot;true&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//可以發現 firstName &amp; isVIP 都被辨識成 text</span></span><br><span class="line">GET my_index/_mapping</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//移除原本的 index</span></span><br><span class="line">DELETE my_index</span><br><span class="line"></span><br><span class="line"><span class="comment">//為 index 設定 dynamic template</span></span><br><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;dynamic_templates&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">        <span class="attr">&quot;strings_as_boolean&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;match_mapping_type&quot;</span>:   <span class="string">&quot;string&quot;</span>,</span><br><span class="line">          <span class="comment">//&quot;is&quot; 開頭的 field 設定為 boolean</span></span><br><span class="line">          <span class="attr">&quot;match&quot;</span>:<span class="string">&quot;is*&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;mapping&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;boolean&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;strings_as_keywords&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;match_mapping_type&quot;</span>:   <span class="string">&quot;string&quot;</span>,</span><br><span class="line">          <span class="comment">//其他的部份則設定為 keyword</span></span><br><span class="line">          <span class="attr">&quot;mapping&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//firstName 會變成 keyword</span></span><br><span class="line"><span class="comment">//isVIP 會變成 boolean</span></span><br><span class="line">PUT my_index/_doc/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;firstName&quot;</span>:<span class="string">&quot;Ruan&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;isVIP&quot;</span>:<span class="string">&quot;true&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET my_index/_mapping</span><br></pre></td></tr></table></figure>

<p>一個以 path 為基礎，並搭配較為複雜處理的設定：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//移除原本的 index</span></span><br><span class="line">DELETE my_index</span><br><span class="line"></span><br><span class="line"><span class="comment">// 設定 dynamic template，以 path match 為基礎</span></span><br><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;dynamic_templates&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;full_name&quot;</span>: &#123;</span><br><span class="line">          <span class="comment">//若符合以下 path 的 match &amp; unmatch 條件</span></span><br><span class="line">          <span class="attr">&quot;path_match&quot;</span>:   <span class="string">&quot;name.*&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;path_unmatch&quot;</span>: <span class="string">&quot;*.middle&quot;</span>,</span><br><span class="line">          <span class="comment">//將資料複製一份到 full_name 欄位</span></span><br><span class="line">          <span class="attr">&quot;mapping&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>:       <span class="string">&quot;text&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;copy_to&quot;</span>:    <span class="string">&quot;full_name&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT my_index/_doc/<span class="number">1</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;first&quot;</span>:  <span class="string">&quot;John&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;middle&quot;</span>: <span class="string">&quot;Winston&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;last&quot;</span>:   <span class="string">&quot;Lennon&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//後面就可以使用額外加入的 full_name 進行搜尋</span></span><br><span class="line"><span class="comment">//full_name 不會出現在 _source 中</span></span><br><span class="line">GET my_index/_search?q=full_name:John</span><br></pre></td></tr></table></figure>



<h1 id="Elasticsearch-聚合分析簡介"><a href="#Elasticsearch-聚合分析簡介" class="headerlink" title="Elasticsearch 聚合分析簡介"></a>Elasticsearch 聚合分析簡介</h1><h2 id="Aggregation"><a href="#Aggregation" class="headerlink" title="Aggregation"></a>Aggregation</h2><ul>
<li><p>Elasticsearc 除了一般的搜尋之外，也可透過 aggergation 的方式，提供數據統計分析的功能，可作到很即時的查詢</p>
</li>
<li><p>透過 aggregation 可以得到分析 &amp; 總結數據後的總覽，而非單一 document，例如：</p>
<ul>
<li><p>某特定區域剩餘的客房數量</p>
</li>
<li><p>進行不同價格區間的搜尋，可預定的平價旅館 &amp; 五星級酒店的數量</p>
</li>
</ul>
</li>
<li><p>效能很好，在 ES 端就可以得到分析結果，不用在 client 端開發分析邏輯</p>
</li>
<li><p>許多 Kibana 報表中的元素都可以透過 aggregation 的數據來完成。例如：</p>
<ul>
<li><p>公司員工的職位分佈、薪水分佈</p>
</li>
<li><p>客戶所在的地理位置分佈</p>
</li>
<li><p>訂單的增減狀況</p>
</li>
</ul>
</li>
</ul>
<h2 id="Aggregation-Family-聚合總類"><a href="#Aggregation-Family-聚合總類" class="headerlink" title="Aggregation Family (聚合總類)"></a>Aggregation Family (聚合總類)</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket.html">Bucket Aggregation</a>：滿足特定條件的 document 集合 (類似傳統 SQL 語法中的 <code>Group By</code>)</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics.html">Metric Aggregation</a>：可透過數學運算，對 document filed 進行統計分析</p>
<ul>
<li><p>基於數據集合計算結果；除了支援在 field 上進行計算，也支援在 (painless) script 產生的結果之上進行計算</p>
</li>
<li><p>大多數的 metric 是數學計算，只會輸出一個值，例如：<strong>min</strong> / <strong>max</strong> / <strong>sum</strong> / <strong>avg</strong> / <strong>cardinality</strong></p>
</li>
<li><p>部份的 metric 支援輸出多個值，例如：<strong>stats</strong> / <strong>percentiles</strong> / <strong>percentile_ranks</strong></p>
</li>
</ul>
</li>
</ul>
<p><img src="/blog/images/Elasticsearch/es_aggregation-01.png" alt="Elasticsearch - Bucket &amp; Metric aggregation"></p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-matrix.html">Matrix Aggregation</a>：支援對多個 field 同時進行操作並提供一個結果矩陣</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-pipeline.html">Pipiline Aggregation</a>: 對其他 aggregation 的結果再一次的進行 aggregation</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-histogram-aggregation.html">Histogram Aggregation</a>：可以針對特定欄位值，指定範圍後一次產生多個 bucket 並統計各範圍的區間值，而統計區間一般是使用數值值型的欄位，但也可以使用<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-datehistogram-aggregation.html">日期欄位</a></p>
</li>
</ul>
<h2 id="範例：Bucketing-分桶"><a href="#範例：Bucketing-分桶" class="headerlink" title="範例：Bucketing (分桶)"></a>範例：Bucketing (分桶)</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根據目的地進行 bucketing 操作</span></span><br><span class="line">GET kibana_sample_data_flights/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;flight_dest&quot;</span>:&#123;</span><br><span class="line">      <span class="comment">//使用 terms 關鍵字，指定要進行 bucketing，使用的是 field DestCountry</span></span><br><span class="line">      <span class="attr">&quot;terms&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>:<span class="string">&quot;DestCountry&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="範例：Bucketing-Metric"><a href="#範例：Bucketing-Metric" class="headerlink" title="範例：Bucketing + Metric"></a>範例：Bucketing + Metric</h2><p>這是 aggregate 後再 aggregate 的範例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查看航班目的地的統計資訊，並以目的地為單位，額外增加平均，最高最低價格</span></span><br><span class="line">GET kibana_sample_data_flights/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">    <span class="comment">//先進行 bucket aggregation 操作</span></span><br><span class="line">    <span class="attr">&quot;flight_dest&quot;</span>:&#123;</span><br><span class="line">      <span class="attr">&quot;terms&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>:<span class="string">&quot;DestCountry&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">//根據上面結果再進行 metric aggregation 操作</span></span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;avg_price&quot;</span>:&#123;</span><br><span class="line">          <span class="attr">&quot;avg&quot;</span>:&#123;</span><br><span class="line">            <span class="attr">&quot;field&quot;</span>:<span class="string">&quot;AvgTicketPrice&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;max_price&quot;</span>:&#123;</span><br><span class="line">          <span class="attr">&quot;max&quot;</span>:&#123;</span><br><span class="line">            <span class="attr">&quot;field&quot;</span>:<span class="string">&quot;AvgTicketPrice&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;min_price&quot;</span>:&#123;</span><br><span class="line">          <span class="attr">&quot;min&quot;</span>:&#123;</span><br><span class="line">            <span class="attr">&quot;field&quot;</span>:<span class="string">&quot;AvgTicketPrice&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="範例：Bucketing-Metric-Matrix"><a href="#範例：Bucketing-Metric-Matrix" class="headerlink" title="範例：Bucketing + Metric + Matrix"></a>範例：Bucketing + Metric + Matrix</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查看航班目的地的統計資訊，並以目的地為單位，額外增加平均票價 &amp; 目的地天氣的統計資訊</span></span><br><span class="line">GET kibana_sample_data_flights/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;flight_dest&quot;</span>:&#123;</span><br><span class="line">      <span class="attr">&quot;terms&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>:<span class="string">&quot;DestCountry&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;stats_price&quot;</span>:&#123;</span><br><span class="line">          <span class="comment">//透過 stats 關鍵字可直接帶出 count/min/max/avg/sum ... 等資訊</span></span><br><span class="line">          <span class="attr">&quot;stats&quot;</span>:&#123;</span><br><span class="line">            <span class="attr">&quot;field&quot;</span>:<span class="string">&quot;AvgTicketPrice&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">				&#125;,</span><br><span class="line">        <span class="attr">&quot;weather&quot;</span>:&#123;</span><br><span class="line">          <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;DestWeather&quot;</span>,</span><br><span class="line">            <span class="comment">//可限定輸出的資料數量，預設為 10</span></span><br><span class="line">            <span class="attr">&quot;size&quot;</span>: <span class="number">5</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="範例：Histogram"><a href="#範例：Histogram" class="headerlink" title="範例：Histogram"></a>範例：Histogram</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查看 price 欄位以 50 為區間的 histogram 資訊</span></span><br><span class="line">POST /sales/_search?size=<span class="number">0</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;prices&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;histogram&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;interval&quot;</span>: <span class="number">50</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//搜尋 agent 為 &quot;Googlebot&quot;，以小時為區間的 histogram 資料</span></span><br><span class="line">GET /kafka-logs/_search?size=<span class="number">0</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;agent&quot;</span>: <span class="string">&quot;Googlebot&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;date_histogram&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;@timestamp&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;hour&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="References-1"><a href="#References-1" class="headerlink" title="References"></a>References</h1><ul>
<li><p><a target="_blank" rel="noopener" href="https://time.geekbang.org/course/intro/100030501">Elasticsearch核心技術與實戰 | 極客時間</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">Elasticsearch Reference [7.9] | Elastic</a></p>
</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/blog/tags/Elasticsearch/" rel="tag"># Elasticsearch</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/blog/DevOps/terraform-input-variables/" rel="prev" title="[Terraform] Input Variables ">
                  <i class="fa fa-chevron-left"></i> [Terraform] Input Variables 
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/blog/Elasticsearch/Elasticsearch-advanced-search/" rel="next" title="[Elasticsearch] 深入搜索">
                  [Elasticsearch] 深入搜索 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  



      
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">godleon</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/@next-theme/pjax@0.4.0/pjax.min.js"></script>
<script src="/blog/js/utils.js"></script><script src="/blog/js/motion.js"></script><script src="/blog/js/schemes/muse.js"></script><script src="/blog/js/next-boot.js"></script>
  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '.page-configurations',
    '.main-inner',
    '.post-toc-wrap',
    '.languages',
    '.pjax'
  ],
  analytics: false,
  cacheBust: false,
  scrollRestoration: false,
  scrollTo: !CONFIG.bookmark.enable
});

document.addEventListener('pjax:success', () => {
  pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  const hasTOC = document.querySelector('.post-toc');
  document.querySelector('.sidebar-inner').classList.toggle('sidebar-nav-active', hasTOC);
  document.querySelector(hasTOC ? '.sidebar-nav-toc' : '.sidebar-nav-overview').click();
  NexT.utils.updateSidebarPosition();
});
</script>


  















  








    <div class="pjax">
  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://godleon-blog-hexo.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "https://godleon.github.io/blog/Elasticsearch/Elasticsearch-getting-started/";
    this.page.identifier = "Elasticsearch/Elasticsearch-getting-started/";
    this.page.title = "[Elasticsearch] 基本概念 & 搜尋入門";
    };
  NexT.utils.loadComments('#disqus_thread', () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://godleon-blog-hexo.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

    </div>
</body>
</html>
